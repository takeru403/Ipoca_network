name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: âœ… ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
      uses: actions/checkout@v3

    - name: ğŸ” EC2ç§˜å¯†éµã‚’è¨­å®š
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/my-new-key.pem
        chmod 600 ~/.ssh/my-new-key.pem
      shell: bash

    - name: ğŸ§¹ EC2ä¸Šã®å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
      run: |
        ssh -i ~/.ssh/my-new-key.pem \
            -o StrictHostKeyChecking=no \
            ec2-user@54.168.159.57 << 'EOF'
          rm -rf ~/Ipoca_network/frontend
          rm -rf ~/Ipoca_network/app/static
          rm -f  ~/Ipoca_network/requirements.txt
          rm -f  ~/Ipoca_network/app/templates/index.html
        EOF
      shell: bash

    - name: ğŸš€ EC2 ã«ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰srcã”ã¨ï¼‰
      run: |
        scp -i ~/.ssh/my-new-key.pem \
            -o StrictHostKeyChecking=no \
            -r frontend ec2-user@54.168.159.57:/home/ec2-user/Ipoca_network/
        scp -i ~/.ssh/my-new-key.pem \
            -o StrictHostKeyChecking=no \
            -r app ec2-user@54.168.159.57:/home/ec2-user/Ipoca_network/
        scp -i ~/.ssh/my-new-key.pem \
            -o StrictHostKeyChecking=no \
            requirements.txt ec2-user@54.168.159.57:/home/ec2-user/Ipoca_network/
      shell: bash

    - name: ğŸ› ï¸ EC2ä¸Šã§ React ãƒ“ãƒ«ãƒ‰ & Flask å†èµ·å‹•
      run: |
        ssh -i ~/.ssh/my-new-key.pem \
            -o StrictHostKeyChecking=no \
            ec2-user@54.168.159.57 << 'EOF'
          # Reactãƒ“ãƒ«ãƒ‰
          cd ~/Ipoca_network/frontend
          npm install
          npm run build

          # Flaskã«Reactæˆæœç‰©ã‚’é…ç½®
          cp -r build/static ../app/static
          mkdir -p ../app/templates
          cp build/index.html ../app/templates/index.html

          # Flaskå†èµ·å‹•
          cd ~/Ipoca_network
          pkill -f gunicorn || true
          pip3 install -r requirements.txt
          gunicorn -b 0.0.0.0:8000 'app:create_app()' --daemon
        EOF
      shell: bash

